{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Claims IQ Core - Document Correction Payload",
  "description": "Canonical correction schema for AI-driven PDF document processing in insurance claims. This schema defines the structure that Claims IQ Core outputs after analyzing claim documents, which is then consumed by a PDF processing engine (e.g., Nutrient) to apply corrections.",
  "version": "1.0.0",
  "type": "object",
  "required": ["correction_job_id", "claim_context", "documents", "generated_at"],
  "properties": {
    "correction_job_id": {
      "type": "string",
      "description": "Unique identifier for this correction job (UUID v4)",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when this correction payload was generated"
    },
    "claim_context": {
      "type": "object",
      "description": "Shared claim-level context extracted across all documents. Used for cross-document validation.",
      "required": ["claim_number", "policy_number", "insured_name"],
      "properties": {
        "claim_number": { "type": "string" },
        "policy_number": { "type": "string" },
        "insured_name": { "type": "string" },
        "date_of_loss": { "type": "string", "format": "date" },
        "property_address": { "type": "string" }
      }
    },
    "documents": {
      "type": "array",
      "description": "Array of documents analyzed in this correction batch",
      "items": { "$ref": "#/definitions/document" }
    },
    "cross_document_validations": {
      "type": "array",
      "description": "Issues found by comparing data across multiple documents in the claim file",
      "items": { "$ref": "#/definitions/cross_document_validation" }
    },
    "summary": {
      "type": "object",
      "description": "Rollup statistics for the correction job",
      "properties": {
        "total_corrections": { "type": "integer" },
        "total_annotations": { "type": "integer" },
        "total_cross_doc_flags": { "type": "integer" },
        "severity_counts": {
          "type": "object",
          "properties": {
            "critical": { "type": "integer" },
            "warning": { "type": "integer" },
            "info": { "type": "integer" }
          }
        },
        "confidence_average": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Average AI confidence across all corrections"
        }
      }
    }
  },
  "definitions": {
    "document": {
      "type": "object",
      "required": ["document_id", "document_type", "source_filename", "corrections"],
      "properties": {
        "document_id": {
          "type": "string",
          "description": "Unique ID for this document within the claim file"
        },
        "document_type": {
          "type": "string",
          "enum": ["fnol", "activity_report", "invoice", "estimate", "photos", "correspondence", "policy_dec", "supplement", "other"],
          "description": "Claims IQ document classification"
        },
        "source_filename": {
          "type": "string",
          "description": "Original filename of the PDF"
        },
        "page_count": {
          "type": "integer"
        },
        "corrections": {
          "type": "array",
          "description": "Text replacement corrections to apply to this document",
          "items": { "$ref": "#/definitions/correction" }
        },
        "annotations": {
          "type": "array",
          "description": "Non-destructive annotations (highlights, comments, flags) to add",
          "items": { "$ref": "#/definitions/annotation" }
        }
      }
    },
    "correction": {
      "type": "object",
      "description": "A single text correction to apply to the PDF",
      "required": ["correction_id", "type", "severity", "location", "original_value", "corrected_value", "reason"],
      "properties": {
        "correction_id": {
          "type": "string",
          "description": "Unique ID for tracking this specific correction"
        },
        "type": {
          "type": "string",
          "enum": [
            "typo",
            "date_error",
            "phone_format",
            "name_mismatch",
            "address_error",
            "numeric_error",
            "missing_value",
            "format_standardization",
            "data_inconsistency"
          ],
          "description": "Classification of the error type"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"],
          "description": "critical = must fix (affects claim validity), warning = should fix (data quality), info = cosmetic/optional"
        },
        "location": {
          "$ref": "#/definitions/location",
          "description": "Where in the PDF the error occurs"
        },
        "original_value": {
          "type": "string",
          "description": "The current (incorrect) text in the document"
        },
        "corrected_value": {
          "type": "string",
          "description": "The replacement text to apply"
        },
        "reason": {
          "type": "string",
          "description": "Human-readable explanation of why this correction is needed"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "AI confidence score for this correction (0.0 to 1.0)"
        },
        "requires_human_review": {
          "type": "boolean",
          "default": false,
          "description": "If true, flag for adjuster review before applying"
        },
        "evidence": {
          "type": "object",
          "description": "Supporting evidence from other documents or external sources",
          "properties": {
            "source_document_id": {
              "type": "string",
              "description": "Document ID where the correct value was found"
            },
            "source_field": {
              "type": "string",
              "description": "Field name in the source document"
            },
            "validation_method": {
              "type": "string",
              "enum": ["cross_document", "pattern_match", "external_lookup", "contextual_inference"],
              "description": "How the correct value was determined"
            }
          }
        }
      }
    },
    "annotation": {
      "type": "object",
      "description": "A non-destructive annotation to add to the PDF (highlight, comment, flag)",
      "required": ["annotation_id", "type", "location", "message"],
      "properties": {
        "annotation_id": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["highlight", "comment", "flag", "strikethrough", "underline"],
          "description": "Visual annotation type"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"]
        },
        "location": {
          "$ref": "#/definitions/location"
        },
        "message": {
          "type": "string",
          "description": "Annotation text / comment content"
        },
        "color": {
          "type": "string",
          "description": "Hex color code for the annotation",
          "pattern": "^#[0-9a-fA-F]{6}$",
          "default": "#FFFF00"
        },
        "category": {
          "type": "string",
          "enum": ["data_quality", "compliance", "review_needed", "cross_doc_mismatch", "suspicious"],
          "description": "Categorization for filtering and reporting"
        }
      }
    },
    "cross_document_validation": {
      "type": "object",
      "description": "A discrepancy found between two or more documents in the claim file",
      "required": ["validation_id", "field_name", "severity", "occurrences", "message"],
      "properties": {
        "validation_id": {
          "type": "string"
        },
        "field_name": {
          "type": "string",
          "description": "The logical field being compared (e.g., 'insured_phone', 'loss_amount', 'date_of_loss')"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"]
        },
        "occurrences": {
          "type": "array",
          "description": "Each occurrence of this field across documents",
          "items": {
            "type": "object",
            "required": ["document_id", "value", "location"],
            "properties": {
              "document_id": { "type": "string" },
              "document_type": { "type": "string" },
              "value": { "type": "string" },
              "location": { "$ref": "#/definitions/location" }
            }
          }
        },
        "expected_value": {
          "type": ["string", "null"],
          "description": "The value Claims IQ Core believes is correct (null if uncertain)"
        },
        "message": {
          "type": "string",
          "description": "Human-readable explanation of the discrepancy"
        },
        "recommended_action": {
          "type": "string",
          "enum": ["auto_correct", "flag_for_review", "escalate", "informational"],
          "description": "What Claims IQ recommends doing about this discrepancy"
        }
      }
    },
    "location": {
      "type": "object",
      "description": "Precise location of text within a PDF page",
      "required": ["page"],
      "properties": {
        "page": {
          "type": "integer",
          "minimum": 1,
          "description": "1-indexed page number"
        },
        "bbox": {
          "type": "object",
          "description": "Bounding box coordinates (PDF coordinate system: origin at bottom-left)",
          "properties": {
            "x": { "type": "number", "description": "Left edge (points from left)" },
            "y": { "type": "number", "description": "Bottom edge (points from bottom)" },
            "width": { "type": "number" },
            "height": { "type": "number" }
          }
        },
        "text_context": {
          "type": "string",
          "description": "Surrounding text to help locate the target (for fuzzy matching when exact coordinates aren't available)"
        },
        "search_text": {
          "type": "string",
          "description": "The exact text string to search for in the PDF (fallback when bbox isn't precise)"
        }
      }
    }
  }
}
